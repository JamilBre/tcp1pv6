<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Simulador TCP - Detalle de Cabecera</title>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .animate-fade-in { animation: fadeIn 0.5s ease-out forwards; }
        body { background-color: #f0f2f5; }
        .tcp-table { border: 1.5px solid #000; font-family: 'Courier New', Courier, monospace; }
        .tcp-table td, .tcp-table th { border: 1px solid #000; padding: 2px 4px; text-align: center; font-size: 9px; }
        .flag-box { border-right: 1px solid #000; height: 100%; display: flex; align-items: center; justify-content: center; min-width: 12px; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect } = React;

        const MonitorIcon = () => (
            <svg xmlns="http://www.w3.org/2000/svg" width="36" height="36" viewBox="0 0 24 24" fill="none" stroke="#3b82f6" strokeWidth="2"><rect width="20" height="14" x="2" y="3" rx="2"/><line x1="8" x2="16" y1="21" y2="21"/><line x1="12" x2="12" y1="17" y2="21"/></svg>
        );

        const ServerIcon = () => (
            <svg xmlns="http://www.w3.org/2000/svg" width="36" height="36" viewBox="0 0 24 24" fill="none" stroke="#1f2937" strokeWidth="2"><rect width="20" height="8" x="2" y="2" rx="2"/><rect width="20" height="8" x="2" y="14" rx="2"/><circle cx="6" cy="6" r="1"/><circle cx="6" cy="18" r="1"/></svg>
        );

        const Node = ({ icon, label, ip }) => (
            <div className="flex flex-col items-center w-52 bg-white/90 backdrop-blur p-3 rounded-xl shadow-md border border-gray-200">
                <div className="mb-2">{icon}</div>
                <div className="font-mono font-bold text-gray-800 text-[9px] text-center break-all leading-tight">{ip}</div>
                <div className="text-[10px] text-indigo-600 font-bold uppercase tracking-widest mt-2">{label}</div>
            </div>
        );

        const TCPHeaderTable = ({ packet }) => {
            const flags = packet.flags || { ns:0, cwr:0, ece:0, urg:0, ack:1, psh:1, rst:0, syn:0, fin:0 };
            
            return (
                <div className="bg-white tcp-table shadow-xl w-[280px]">
                    {/* Row 1: Ports */}
                    <div className="grid grid-cols-2 border-b border-black">
                        <div className="p-1 border-r border-black">Pto origen: <span className="font-bold">{packet.portOrig}</span></div>
                        <div className="p-1">Pto destino: <span className="font-bold">{packet.portDest}</span></div>
                    </div>
                    {/* Row 2: Seq Number */}
                    <div className="p-1 border-b border-black text-center">
                        Número de secuencia: <span className="font-bold">{packet.seq}</span> (32)
                    </div>
                    {/* Row 3: ACK Number */}
                    <div className="p-1 border-b border-black text-center">
                        Número de confirmación - ACK: <span className="font-bold">{packet.ackNum}</span> (32)
                    </div>
                    {/* Row 4: Header Len, Res, Flags, Window */}
                    <div className="flex border-b border-black text-[7px] font-bold">
                        <div className="w-8 border-r border-black p-0.5 leading-none">H.Len<br/>(4)</div>
                        <div className="w-10 border-r border-black p-0.5 leading-none">Res.<br/>000</div>
                        <div className="flex grow">
                            {['NS','CWR','ECE','URG','ACK','PSH','RST','SYN','FIN'].map(f => (
                                <div key={f} className={`flex-1 border-r border-black text-center ${flags[f.toLowerCase()] ? 'bg-yellow-100 text-red-600' : 'text-gray-400'}`}>
                                    {f}
                                </div>
                            ))}
                        </div>
                        <div className="w-20 p-0.5 text-center leading-none">Tam. Ventana<br/>{packet.window}</div>
                    </div>
                    {/* Row 5: Checksum & Urgent */}
                    <div className="grid grid-cols-2 border-b border-black">
                        <div className="p-1 border-r border-black">Checksum: <span className="font-bold">0x{packet.checksum}</span></div>
                        <div className="p-1">Urgent pointer: <span className="font-bold">0</span></div>
                    </div>
                    {/* Row 6: Options */}
                    <div className="p-1 border-b border-black text-center italic text-gray-500">
                        Opciones (MSS: 1460, SACK Permitted)
                    </div>
                    {/* Row 7: Data */}
                    <div className={`p-2 text-center font-bold ${packet.type === 'response' ? 'text-green-700 bg-green-50' : 'text-blue-700 bg-blue-50'}`}>
                        DATOS: "{packet.message}"
                    </div>
                </div>
            );
        };

        const PacketArrow = ({ packet, startX, endX }) => {
            const startPos = parseFloat(startX);
            const endPos = parseFloat(endX);
            const midPos = (startPos + endPos) / 2;
            
            return (
                <div className="w-full relative py-4 animate-fade-in">
                    <div 
                        className="absolute -top-28 z-20"
                        style={{ left: `${midPos}%`, transform: 'translateX(-50%)' }}
                    >
                        <TCPHeaderTable packet={packet} />
                    </div>

                    <svg className="w-full h-16 overflow-visible">
                        <defs>
                            <marker id={`arrowhead-${packet.id}`} markerWidth="10" markerHeight="7" refX="9" refY="3.5" orient="auto">
                                <polygon points="0 0, 10 3.5, 0 7" fill="#475569" />
                            </marker>
                        </defs>
                        <line
                            x1={`${startX}`} y1="20"
                            x2={`${endX}`} y2="40"
                            stroke="#475569" strokeWidth="2.5"
                            strokeDasharray={packet.type === 'response' ? "6,4" : "0"}
                            markerEnd={`url(#arrowhead-${packet.id})`}
                        />
                    </svg>
                </div>
            );
        };

        const App = () => {
            const [visiblePackets, setVisiblePackets] = useState([]);
            const [isPlaying, setIsPlaying] = useState(false);

            const serverIP = "fd00::ea9c:25ff:fe80:bd0b";
            const client1IP = "fd00::ce28:aaff:fe28:aa01";
            const client2IP = "fd00::39bb:deff:fe3b:9bde";

            const packets = [
                { 
                    id: 1, from: 'client1', to: 'server', 
                    ipOrig: client1IP, ipDest: serverIP, 
                    portOrig: '49512', portDest: '8080', 
                    seq: '1000', ackNum: '0', window: '64240', checksum: 'A4F2',
                    message: 'holacomoestas', type: 'request' 
                },
                { 
                    id: 2, from: 'server', to: 'client1', 
                    ipOrig: serverIP, ipDest: client1IP, 
                    portOrig: '8080', portDest: '49512', 
                    seq: '500', ackNum: '1013', window: '16384', checksum: 'B1D3',
                    message: 'krodfrprhvwdv', type: 'response' 
                },
                { 
                    id: 3, from: 'client2', to: 'server', 
                    ipOrig: client2IP, ipDest: serverIP, 
                    portOrig: '55231', portDest: '8080', 
                    seq: '2000', ackNum: '0', window: '64240', checksum: 'C8E1',
                    message: 'bien_gracias', type: 'request' 
                },
                { 
                    id: 4, from: 'server', to: 'client2', 
                    ipOrig: serverIP, ipDest: client2IP, 
                    portOrig: '8080', portDest: '55231', 
                    seq: '800', ackNum: '2012', window: '16384', checksum: 'D9A4',
                    message: 'elhqbjudfldv', type: 'response' 
                }
            ];

            useEffect(() => {
                let interval;
                if (isPlaying && visiblePackets.length < packets.length) {
                    interval = setInterval(() => {
                        setVisiblePackets((prev) => [...prev, packets[prev.length]]);
                    }, 2500);
                } else if (visiblePackets.length === packets.length) {
                    setIsPlaying(false);
                }
                return () => clearInterval(interval);
            }, [isPlaying, visiblePackets]);

            const getXPosition = (node) => {
                if (node === 'client1') return '15%';
                if (node === 'server') return '50%';
                if (node === 'client2') return '85%';
                return '0%';
            };

            return (
                <div className="flex flex-col items-center justify-start min-h-screen p-4">
                    <div className="max-w-6xl w-full bg-white rounded-2xl shadow-2xl p-6 border border-gray-200 relative">
                        <div className="flex justify-between items-center mb-10 border-b pb-4">
                            <div>
                                <h1 className="text-2xl font-black text-gray-900 uppercase">Captura de Tráfico TCP</h1>
                                <p className="text-xs text-gray-500 font-mono tracking-tighter">PROTOCOLO: TCP | ARCHIVO: TCPencriptacion.pcapng</p>
                            </div>
                            <div className="flex gap-2">
                                <button 
                                    onClick={() => setIsPlaying(true)}
                                    disabled={isPlaying || visiblePackets.length === packets.length}
                                    className="bg-blue-600 hover:bg-blue-700 text-white px-5 py-2 rounded-lg font-bold text-sm transition-all disabled:opacity-50 active:scale-95"
                                >
                                    CAPTURA
                                </button>
                                <button 
                                    onClick={() => {setVisiblePackets([]); setIsPlaying(false);}}
                                    className="bg-gray-100 hover:bg-gray-200 text-gray-700 px-5 py-2 rounded-lg font-bold text-sm border border-gray-300 transition-all active:scale-95"
                                >
                                    LIMPIAR
                                </button>
                            </div>
                        </div>

                        {/* Sequence Diagram */}
                        <div className="relative min-h-[1100px] w-full pt-40 pb-20">
                            
                            {/* Nodos */}
                            <div className="flex justify-between items-start absolute top-4 left-0 w-full px-2 z-30">
                                <div style={{left: '15%', transform: 'translateX(-50%)'}} className="absolute">
                                    <Node icon={<MonitorIcon />} label="Cliente 1" ip={client1IP} />
                                </div>
                                <div style={{left: '50%', transform: 'translateX(-50%)'}} className="absolute">
                                    <Node icon={<ServerIcon />} label="Servidor TCP" ip={serverIP} />
                                </div>
                                <div style={{left: '85%', transform: 'translateX(-50%)'}} className="absolute">
                                    <Node icon={<MonitorIcon />} label="Cliente 2" ip={client2IP} />
                                </div>
                            </div>

                            {/* Lifelines */}
                            <div className="absolute top-10 bottom-0 left-[15%] w-[2px] bg-gray-200"></div>
                            <div className="absolute top-10 bottom-0 left-[50%] w-[2px] bg-gray-300"></div>
                            <div className="absolute top-10 bottom-0 left-[85%] w-[2px] bg-gray-200"></div>

                            {/* Packets */}
                            <div className="mt-48 space-y-64 flex flex-col items-center relative z-10">
                                {visiblePackets.map((pkt) => (
                                    <PacketArrow 
                                        key={pkt.id} 
                                        packet={pkt} 
                                        startX={getXPosition(pkt.from)} 
                                        endX={getXPosition(pkt.to)} 
                                    />
                                ))}
                            </div>
                        </div>
                    </div>
                    
                    <div className="mt-6 text-[10px] text-gray-400 text-center uppercase tracking-widest leading-relaxed">
                        Visualización técnica de Segmentos TCP <br/>
                        Estructura de cabecera de 20 bytes (sin opciones extendidas)
                    </div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
