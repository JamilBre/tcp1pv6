<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Simulador TCP - Conversación Completa (11 Paquetes)</title>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .animate-fade-in { animation: fadeIn 0.4s ease-out forwards; }
        body { background-color: #f8fafc; }
        .tcp-table { border: 1.5px solid #000; font-family: 'Courier New', Courier, monospace; }
        .tcp-table td, .tcp-table th { border: 1px solid #000; padding: 1px 3px; text-align: center; font-size: 8px; }
        .lifeline-label { writing-mode: vertical-rl; text-orientation: mixed; }
        .vertical-text { display: flex; flex-direction: column; align-items: center; justify-content: center; font-size: 5px; line-height: 1.1; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        const MonitorIcon = () => (
            <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="#3b82f6" strokeWidth="2"><rect width="20" height="14" x="2" y="3" rx="2"/><line x1="8" x2="16" y1="21" y2="21"/><line x1="12" x2="12" y1="17" y2="21"/></svg>
        );

        const ServerIcon = () => (
            <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="#1e293b" strokeWidth="2"><rect width="20" height="8" x="2" y="2" rx="2"/><rect width="20" height="8" x="2" y="14" rx="2"/><circle cx="6" cy="6" r="1"/><circle cx="6" cy="18" r="1"/></svg>
        );

        const Node = ({ icon, label, ip }) => (
            <div className="flex flex-col items-center w-52 bg-white p-2 rounded-lg shadow-sm border border-gray-200 z-30">
                <div className="mb-1">{icon}</div>
                <div className="font-mono font-bold text-gray-800 text-[8px] text-center break-all leading-tight">{ip}</div>
                <div className="text-[9px] text-blue-600 font-bold uppercase tracking-widest mt-1">{label}</div>
            </div>
        );

        const TCPHeaderTable = ({ packet }) => {
            const f = packet.flags || { ns:0, cwr:0, ece:0, urg:0, ack:0, psh:0, rst:0, syn:0, fin:0 };
            
            return (
                <div className="flex flex-col items-center">
                    <div className="bg-blue-600 text-white font-bold px-3 py-1.5 rounded-t-md max-w-[280px] w-[280px] text-center shadow-md z-10 border border-blue-800 flex flex-col gap-0.5">
                        <span className="text-[8px] text-blue-200 font-mono tracking-wider">FRAME: {packet.frame} | TIME: {packet.time}</span>
                        <span className="text-[10px]">{packet.description}</span>
                    </div>
                    <div className="bg-white tcp-table shadow-xl w-[280px] text-black">
                        <div className="grid grid-cols-2 border-b border-black">
                            <div className="p-0.5 border-r border-black">Puerto origen (16): <br/><span className="font-bold text-blue-700">{packet.portOrig}</span></div>
                            <div className="p-0.5">Puerto destino (16): <br/><span className="font-bold text-blue-700">{packet.portDest}</span></div>
                        </div>
                        <div className="p-0.5 border-b border-black text-center text-[8px]">
                            Número de secuencia (32): <span className="font-bold">{packet.seq}</span>
                        </div>
                        <div className="p-0.5 border-b border-black text-center text-[8px]">
                            Número de confirmación - ACK (32): <span className="font-bold">{packet.ackNum}</span>
                        </div>
                        <div className="flex border-b border-black text-[6px] font-bold h-12">
                            <div className="w-8 border-r border-black flex flex-col items-center justify-center text-center leading-tight bg-gray-50">
                                <span>Header</span><span>lenght</span><span>(4)</span>
                                <span className="text-[9px] mt-0.5 text-blue-700">{packet.headerLen}</span>
                            </div>
                            <div className="w-8 border-r border-black flex items-center justify-center text-center leading-tight bg-gray-50">Reser-<br/>vado<br/>000</div>
                            <div className="flex grow">
                                {['NS','CWR','ECE','URG','ACK','PSH','RST','SYN','FIN'].map(flag => (
                                    <div key={flag} className={`flex-1 border-r border-black vertical-text font-bold ${f[flag.toLowerCase()] ? 'bg-yellow-200 text-red-600' : 'text-gray-400'}`}>
                                        {flag.split('').map((char, i) => <span key={i}>{char}</span>)}
                                    </div>
                                ))}
                            </div>
                            <div className="w-16 flex flex-col items-center justify-center text-center border-black bg-gray-50">
                                <span>Tamaño de</span>
                                <span>ventana (16)</span>
                                <span className="font-bold mt-0.5 text-blue-700">{packet.window}</span>
                            </div>
                        </div>
                        <div className="grid grid-cols-2 border-b border-black">
                            <div className="p-0.5 border-r border-black">Checksum (16): <br/><span className="font-bold text-purple-700">{packet.checksum}</span></div>
                            <div className="p-0.5">Urgent pointer (16): <br/><span className="font-bold">0</span></div>
                        </div>
                        <div className="p-1 border-b border-black text-center text-[8px]">
                            Opciones (0 - 40): <span className="font-normal italic text-gray-700">{packet.options}</span>
                        </div>
                        <div className={`p-1.5 flex flex-col items-center justify-center text-center text-[9px] font-bold ${packet.stage === 'Data' ? 'bg-green-50' : 'bg-gray-50'}`}>
                            <div className="mb-0.5">Datos <span className="text-gray-500 text-[8px]">(Len={packet.len})</span>: <span className={packet.type === 'response' ? 'text-green-600' : 'text-blue-600'}>{packet.message}</span></div>
                        </div>
                    </div>
                </div>
            );
        };

        const PacketArrow = ({ packet, startX, endX }) => {
            const isResponse = packet.type === 'response';
            const midX = (parseFloat(startX) + parseFloat(endX)) / 2;

            return (
                <div className="w-full relative py-2 animate-fade-in group z-20">
                    <div 
                        className="absolute -top-44 z-30 transition-transform group-hover:scale-105"
                        style={{ left: `${midX}%`, transform: 'translateX(-50%)' }}
                    >
                        <TCPHeaderTable packet={packet} />
                    </div>

                    <svg className="w-full h-12 overflow-visible relative z-10">
                        <defs>
                            <marker id={`arrow-${packet.id}`} markerWidth="8" markerHeight="6" refX="7" refY="3" orient="auto">
                                <polygon points="0 0, 8 3, 0 6" fill="#475569" />
                            </marker>
                        </defs>
                        <line
                            x1={`${startX}`} y1="10"
                            x2={`${endX}`} y2="30"
                            stroke="#475569" strokeWidth="2.5"
                            strokeDasharray={isResponse ? "4,2" : "0"}
                            markerEnd={`url(#arrow-${packet.id})`}
                        />
                    </svg>
                </div>
            );
        };

        const App = () => {
            const [visiblePackets, setVisiblePackets] = useState([]);
            const [isPlaying, setIsPlaying] = useState(false);

            // Nuevas IPs basadas en los roles correctos de tcp.txt
            const client1IP = "fd00::ea9c:25ff:fe80:bd0b"; // Origen Frame 11 (Port 54002)
            const serverIP = "fd00::ce28:aaff:fe1b:1c02";  // Destino Frame 11 (Port 5000)

            const packets = [
                // Establecimiento (Handshake) - Frames 11 a 13
                { id: 1, frame: 11, time: '13.390451', stage: 'Handshake', from: 'client1', to: 'server', portOrig: '54002', portDest: '5000', seq: '0', ackNum: '0', window: '65535', options: 'MSS=1440 WS=256 SACK_PERM', headerLen: '8', len: '0', checksum: '0x9e71', flags: { syn: 1 }, message: '[SYN]', type: 'request', description: 'Handshake 1: Cliente envía SYN' },
                { id: 2, frame: 12, time: '13.390703', stage: 'Handshake', from: 'server', to: 'client1', portOrig: '5000', portDest: '54002', seq: '0', ackNum: '1', window: '65535', options: 'MSS=1440 WS=256 SACK_PERM', headerLen: '8', len: '0', checksum: '0x5997', flags: { syn: 1, ack: 1 }, message: '[SYN, ACK]', type: 'response', description: 'Handshake 2: Servidor responde SYN-ACK' },
                { id: 3, frame: 13, time: '13.393664', stage: 'Handshake', from: 'client1', to: 'server', portOrig: '54002', portDest: '5000', seq: '1', ackNum: '1', window: '65280', options: 'Ninguna', headerLen: '5', len: '0', checksum: '0x47c2', flags: { ack: 1 }, message: '[ACK]', type: 'request', description: 'Handshake 3: Cliente confirma (ACK)' },
                
                // Transferencia de Datos - Frames 14, 15, 22, 23
                { id: 4, frame: 14, time: '13.394693', stage: 'Data', from: 'server', to: 'client1', portOrig: '5000', portDest: '54002', seq: '1', ackNum: '1', window: '65280', options: 'Ninguna', headerLen: '5', len: '18', checksum: '0x599d', flags: { psh: 1, ack: 1 }, message: 'Envia el mensaje: ', type: 'response', description: 'Datos 1: Servidor envía prompt inicial' },
                { id: 5, frame: 15, time: '13.438312', stage: 'Data', from: 'client1', to: 'server', portOrig: '54002', portDest: '5000', seq: '1', ackNum: '19', window: '65280', options: 'Ninguna', headerLen: '5', len: '0', checksum: '0x47b0', flags: { ack: 1 }, message: '[ACK]', type: 'request', description: 'Datos 2: Cliente confirma (ACK) el prompt' },
                { id: 6, frame: 22, time: '22.291990', stage: 'Data', from: 'client1', to: 'server', portOrig: '54002', portDest: '5000', seq: '1', ackNum: '19', window: '65280', options: 'Ninguna', headerLen: '5', len: '18', checksum: '0x1315', flags: { psh: 1, ack: 1 }, message: 'como estas server', type: 'request', description: 'Datos 3: Cliente envía mensaje a cifrar' },
                { id: 7, frame: 23, time: '22.293002', stage: 'Data', from: 'server', to: 'client1', portOrig: '5000', portDest: '54002', seq: '19', ackNum: '19', window: '65280', options: 'Ninguna', headerLen: '5', len: '18', checksum: '0x599d', flags: { psh: 1, ack: 1 }, message: 'frpr hvwdv vhuyhu', type: 'response', description: 'Datos 4: Servidor contesta texto cifrado' },
                
                // Cierre (Termination) - Frames 24 a 27
                { id: 8, frame: 24, time: '22.293538', stage: 'Closure', from: 'server', to: 'client1', portOrig: '5000', portDest: '54002', seq: '37', ackNum: '19', window: '65280', options: 'Ninguna', headerLen: '5', len: '0', checksum: '0x598b', flags: { fin: 1, ack: 1 }, message: '[FIN, ACK]', type: 'response', description: 'Cierre 1: Servidor inicia cierre (FIN)' },
                { id: 9, frame: 25, time: '22.295573', stage: 'Closure', from: 'client1', to: 'server', portOrig: '54002', portDest: '5000', seq: '19', ackNum: '38', window: '65280', options: 'Ninguna', headerLen: '5', len: '0', checksum: '0x478b', flags: { ack: 1 }, message: '[ACK]', type: 'request', description: 'Cierre 2: Cliente confirma (ACK)' },
                { id: 10, frame: 26, time: '22.296810', stage: 'Closure', from: 'client1', to: 'server', portOrig: '54002', portDest: '5000', seq: '19', ackNum: '38', window: '65280', options: 'Ninguna', headerLen: '5', len: '0', checksum: '0x478a', flags: { fin: 1, ack: 1 }, message: '[FIN, ACK]', type: 'request', description: 'Cierre 3: Cliente envía su FIN' },
                { id: 11, frame: 27, time: '22.296975', stage: 'Closure', from: 'server', to: 'client1', portOrig: '5000', portDest: '54002', seq: '38', ackNum: '20', window: '65280', options: 'Ninguna', headerLen: '5', len: '0', checksum: '0x598b', flags: { ack: 1 }, message: '[ACK]', type: 'response', description: 'Cierre 4: Servidor confirma (ACK). Fin.' }
            ];

            useEffect(() => {
                let interval;
                if (isPlaying && visiblePackets.length < packets.length) {
                    interval = setInterval(() => {
                        setVisiblePackets(prev => [...prev, packets[prev.length]]);
                    }, 2600); // 2.6s por la cantidad de info
                } else {
                    setIsPlaying(false);
                }
                return () => clearInterval(interval);
            }, [isPlaying, visiblePackets]);

            const getX = (node) => {
                if (node === 'client1') return '20%';
                if (node === 'server') return '50%';
                if (node === 'client2') return '80%';
                return '0%';
            };

            return (
                <div className="min-h-screen p-4 flex flex-col items-center">
                    <div className="max-w-6xl w-full bg-white border border-gray-200 rounded-2xl shadow-xl overflow-hidden">
                        
                        {/* Control Panel */}
                        <div className="p-6 border-b flex justify-between items-center bg-slate-50 sticky top-0 z-40 shadow-sm">
                            <div>
                                <h1 className="text-xl font-black text-slate-800 uppercase tracking-tight">Análisis Detallado TCP (Wireshark)</h1>
                                <p className="text-[10px] text-slate-500 font-mono italic">Captura tcp.txt | Sesión Extendida (11 Paquetes) | Roles Reales</p>
                            </div>
                            <div className="flex gap-2">
                                <button 
                                    onClick={() => setIsPlaying(true)}
                                    disabled={isPlaying || visiblePackets.length === packets.length}
                                    className="bg-blue-600 hover:bg-blue-700 text-white px-5 py-2.5 rounded-lg text-xs font-bold transition-all disabled:opacity-30 shadow-md active:scale-95"
                                >
                                    EJECUTAR SECUENCIA
                                </button>
                                <button 
                                    onClick={() => {setVisiblePackets([]); setIsPlaying(false);}}
                                    className="bg-white border border-gray-300 text-gray-700 px-5 py-2.5 rounded-lg text-xs font-bold hover:bg-gray-50 transition-all active:scale-95"
                                >
                                    REINICIAR
                                </button>
                            </div>
                        </div>

                        {/* Sequence Diagram Area */}
                        <div className="relative min-h-[3500px] w-full pt-44 pb-20 bg-[radial-gradient(#e5e7eb_1px,transparent_1px)] [background-size:20px_20px]">
                            
                            {/* Static Labels on top */}
                            <div className="absolute top-8 left-0 w-full flex justify-between px-4 z-30">
                                <div style={{left: '20%', transform: 'translateX(-50%)'}} className="absolute">
                                    <Node icon={<MonitorIcon />} label="Cliente TCP (fd00::ea9c...)" ip={client1IP} />
                                </div>
                                <div style={{left: '50%', transform: 'translateX(-50%)'}} className="absolute">
                                    <Node icon={<ServerIcon />} label="Servidor TCP (fd00::ce28...)" ip={serverIP} />
                                </div>
                                <div style={{left: '80%', transform: 'translateX(-50%)'}} className="absolute opacity-60">
                                    <Node icon={<MonitorIcon />} label="Nodo Inactivo" ip="-" />
                                </div>
                            </div>

                            {/* Lifelines */}
                            <div className="absolute top-12 bottom-0 left-[20%] w-[1px] bg-slate-300 border-l-2 border-dashed border-blue-200"></div>
                            <div className="absolute top-12 bottom-0 left-[50%] w-[1px] bg-slate-300 border-l-2 border-dashed border-gray-400"></div>
                            <div className="absolute top-12 bottom-0 left-[80%] w-[1px] bg-slate-200 border-l border-dashed"></div>

                            {/* Packet Sequence */}
                            <div className="mt-48 space-y-[260px] flex flex-col items-center relative z-10">
                                {visiblePackets.map((pkt) => (
                                    <PacketArrow 
                                        key={pkt.id} 
                                        packet={pkt} 
                                        startX={getX(pkt.from)} 
                                        endX={getX(pkt.to)} 
                                    />
                                ))}
                            </div>

                            {/* Phase Indicators */}
                            <div className="absolute left-6 top-[10%] opacity-20 pointer-events-none">
                                <div className="text-5xl font-black text-slate-400 uppercase rotate-90 lifeline-label tracking-widest">Handshake</div>
                            </div>
                            <div className="absolute left-6 top-[40%] opacity-20 pointer-events-none">
                                <div className="text-5xl font-black text-blue-400 uppercase rotate-90 lifeline-label tracking-widest">Transferencia</div>
                            </div>
                            <div className="absolute left-6 top-[80%] opacity-20 pointer-events-none">
                                <div className="text-5xl font-black text-red-400 uppercase rotate-90 lifeline-label tracking-widest">Terminación</div>
                            </div>
                        </div>
                    </div>

                    <div className="mt-8 text-center max-w-3xl">
                        <div className="inline-block px-4 py-1 bg-green-100 text-green-800 rounded-full text-[10px] font-bold uppercase tracking-widest mb-4 border border-green-200">
                            Simulación de 11 Frames (tcp.txt)
                        </div>
                        <p className="text-xs text-gray-500 leading-relaxed font-mono">
                            Los datos incluyen los mensajes: "Envia el mensaje:", "como estas server" y "frpr hvwdv vhuyhu". La desconexión FIN fue iniciada por el Servidor.
                        </p>
                    </div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
